#!/usr/bin/env bash

set -e

source $(dirname "$0")/common.sh

read_env
read_params "$@"

get_var MAGENTO_REMOTE_SSH
get_var MAGENTO_REMOTE_DATABASE_HOST "localhost"
get_var MAGENTO_REMOTE_DATABASE_NAME
get_var MAGENTO_REMOTE_DATABASE_USERNAME
get_var MAGENTO_REMOTE_DATABASE_PASSWORD "" "1"
get_var MAGENTO_REMOTE_DATABASE_IGNORE_TABLES "0"

get_var MAGENTO_REMOTE_DUMP_PATH

save_env

DEFINER_REPLACE_SCRIPT="s/DEFINER[ ]*=[ ]*[^*]*\*/\*/"

DATABASE_DUMP_NAME="${MAGENTO_REMOTE_DATABASE_NAME}-${RANDOM}"
DATABASE_DUMP_SCHEMA="${DATABASE_DUMP_NAME}-schema.sql.gz"
DATABASE_DUMP_DATA="${DATABASE_DUMP_NAME}-data.sql.gz"

DATABASE_DUMP_REMOTE_SCHEMA="${MAGENTO_REMOTE_DUMP_PATH}/${DATABASE_DUMP_SCHEMA}"
DATABASE_DUMP_REMOTE_DATA="${MAGENTO_REMOTE_DUMP_PATH}/${DATABASE_DUMP_DATA}"

LOCAL_DUMP_PATH="${ROOT_PATH}/var"

DATABASE_DUMP_LOCAL_SCHEMA="${LOCAL_DUMP_PATH}/${DATABASE_DUMP_SCHEMA}"
DATABASE_DUMP_LOCAL_DATA="${LOCAL_DUMP_PATH}/${DATABASE_DUMP_DATA}"

DATABASE_DUMP_IGNORE_TABLES=""
if [ "$MAGENTO_REMOTE_DATABASE_IGNORE_TABLES" != "0" ]; then
    for MAGENTO_REMOTE_DATABASE_IGNORE_TABLE in ${MAGENTO_REMOTE_DATABASE_IGNORE_TABLES}
    do
        DATABASE_DUMP_IGNORE_TABLES="${DATABASE_DUMP_IGNORE_TABLES} --ignore-table=${MAGENTO_REMOTE_DATABASE_NAME}.${MAGENTO_REMOTE_DATABASE_IGNORE_TABLE}"
    done
fi

DATABASE_DUMP_ARGS="-h${MAGENTO_REMOTE_DATABASE_HOST} -u ${MAGENTO_REMOTE_DATABASE_USERNAME} -p${MAGENTO_REMOTE_DATABASE_PASSWORD} ${MAGENTO_REMOTE_DATABASE_NAME}"

run "ssh -q ${MAGENTO_REMOTE_SSH} \"mysqldump --no-data ${DATABASE_DUMP_ARGS} | sed -e '${DEFINER_REPLACE_SCRIPT}' | gzip > ${DATABASE_DUMP_REMOTE_SCHEMA}\""
run "scp -q ${MAGENTO_REMOTE_SSH}:${DATABASE_DUMP_REMOTE_SCHEMA} ${DATABASE_DUMP_LOCAL_SCHEMA}"
run "ssh -q ${MAGENTO_REMOTE_SSH} \"rm ${DATABASE_DUMP_REMOTE_SCHEMA}\""
msg "DATABASE_DUMP_SCHEMA: ${DATABASE_DUMP_LOCAL_SCHEMA}"

run "ssh -q ${MAGENTO_REMOTE_SSH} \"mysqldump --no-create-info ${DATABASE_DUMP_IGNORE_TABLES} --skip-triggers --quick ${DATABASE_DUMP_ARGS} | sed -e '${DEFINER_REPLACE_SCRIPT}' | gzip > ${DATABASE_DUMP_REMOTE_DATA}\""
run "scp -q ${MAGENTO_REMOTE_SSH}:${DATABASE_DUMP_REMOTE_DATA} ${DATABASE_DUMP_LOCAL_DATA}"
run "ssh -q ${MAGENTO_REMOTE_SSH} \"rm ${DATABASE_DUMP_REMOTE_DATA}\""
msg "DATABASE_DUMP_DATA: ${DATABASE_DUMP_LOCAL_DATA}"
